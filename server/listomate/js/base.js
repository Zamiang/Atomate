debug=function(a){console.log(a)};
Atomate={notesList:jQuery("#notes"),tabsList:jQuery("#tabs"),searchDiv:jQuery("#main_input"),settingsDiv:jQuery("#settings"),inputControlsDiv:jQuery("#input .controls"),defaultTabs:[{name:"Now",type:"native",def:true},{name:"Notes",type:"native"},{name:"Todo",type:"native"},{name:"Events",type:"native"},{name:"People",type:"native"},{name:"javascript",type:"search",search:"#javascript"}],initialize:function(a){var b=this;this.database.initialize();this.auth.initialize();this.tracking.initialize(a);
this.tabs=a.tabs||this.defaultTabs;var c=this.getStartingTab();this.getData(function(){b.autocomplete.initialize();b.buildTabs(b.tabs,c);b.setupSearch(b.searchDiv,b.notes);b.setupMouseEvents();b.noteEdit.initialize();b.updateNotesDisplay(c.name.toLowerCase(),c.type)})},setupMouseEvents:function(){var a=this;jQuery("textarea").live("keyup",function(){a.resizeIt(jQuery(this))});this.tabsList.find("li").live("click",function(){var b=jQuery(this),c=b.attr("data-name").toLowerCase();b=b.attr("data-type").toLowerCase();
Atomate.changeTab(c,b);return false});this.notesList.find("li").live("click",function(){jQuery(this).toggleClass("selected")});this.notesList.find("li .hash_link, li .at_link").live("click",function(){var b=jQuery(this).attr("data-id");a.searchString=b;a.updateNotesDisplay(undefined,undefined,true)});this.notesList.find("li .remove_custom_search").live("click",function(b){b.stopPropagation();jQuery(this).parent().parent().remove();a.removeCustomSearch();return false});this.notesList.find("li.note").live("dblclick",
function(){var b=jQuery(this);a.noteEdit.editNote(b)});this.notesList.find("li .actions .item_remove").live("click",function(b){b.stopPropagation();jQuery(this).parent().parent().slideUp();return false});this.notesList.find("li .actions .item_edit").live("click",function(b){b.stopPropagation();return false});jQuery(".popup .remove").live("click",function(){a.hidePopup()})},resizeIt:function(a){var b=a.val(),c=a.attr("cols"),d=0;b.split("\n").map(function(e){d+=1+Math.floor(e.length/c)});a.attr({rows:d})},
changeTab:function(a,b){this.searhchString=undefined;if(b=="add")this.showAddPopup();else if(b=="settings"){this.tabsList.find("li").removeClass("selected");jQuery("#notes, #main_input").hide();this.settingsDiv.show()}else{jQuery("#notes, #main_input").show();this.settingsDiv.hide();this.updateNotesDisplay(a,b);this.tabsList.find("li").removeClass("selected");this.tabsList.find(".tab_"+a).addClass("selected")}},showAddPopup:function(){this.showPopup("add_tab")},buildTabs:function(a,b){var c=this;
jQuery.fn.append.apply(jQuery("#sort_tabs"),a.map(function(d){return c.templates.getTabHtml(d,b,true)}));a.push({name:"+",type:"add"});jQuery.fn.append.apply(this.tabsList,a.map(function(d){return c.templates.getTabHtml(d,b,false)}))},updateNotesDisplay:function(a,b,c){if(a!=this.name){b=b||this.type;a=a||this.name;this.type=b;this.name=a;if(!this.searchString||!this.searchString.trim())this.searchString=undefined;if(this.searchString){debug("searching");a=this.getNotesForType(a,b);a=this.searchNotesSimple(this.searchString,
a,a)}else{debug("notsearching");a=this.getNotesForType(a,b)}this.notesList.html("");c&&this.searchString&&this.addCustomSearchDisplay(this.searchString);this.addNotes(a);this.notesList.scrollTop(0)}},addCustomSearchDisplay:function(a){this.notesList.append(this.templates.getCustomSearchHtml(a))},removeCustomSearch:function(){this.searchString="";this.updateNotesDisplay()},getNotesForType:function(a,b){b=b||this.type;a=a||this.name;if(b=="native"){if(a=="people")return this.people;else if(a=="now"){var c=
(new Date).valueOf(),d=c+2592E5,e=c-5184E5;return this.notes.filter(function(f){return f.reminder&&!isNaN(f.reminder)?f.reminder<=d&&f.reminder>=c:f.edited>e}).sort(function(f,g){return(f.reminder||f.edited)-(g.reminder||g.edited)})}else if(a=="todo")return this.notes.filter(function(f){return f.contents.indexOf("todo")>-1});else if(a=="notes")return this.notes.filter(function(f){return f.category=="Reference"||f.category=="Journal"});else if(a=="events")return this.notes.filter(function(f){return f.type==
"event"}).sort(function(f,g){return(f.reminder||f.edited)-(g.reminder||g.edited)});return this.notes}else if(b=="search")return this.searchNotesSimple(this.getTabForTabName(a).search,this.notes,this.notes)},getTabForTabName:function(a){return this.tabs.filter(function(b){return b.name.toLowerCase()==a.toLowerCase()})[0]},getLocationHash:function(){return window.location.hash.replace("#","")},setupSearch:function(a){var b=this;a.keyup(function(c){try{var d=c.which,e=jQuery(this).val();b.searchString=
e?e.trim():undefined;if(!(d==39||d==37||d==190))if(!e||e.replace(/\n/g,"").length<1)b.inputControlsDiv.hide();else b.inputControlsDiv.is(":hidden")&&b.inputControlsDiv.show()}catch(f){console.log(f)}})},searchNotesSimple:function(a,b){return b.filter(function(c){if((c=c.contents?c.contents:c.searchTxt)&&c.indexOf(a)>-1)return true;return false})},getData:function(a){var b=this;this.database.notes.getAllNotes(false,false,function(c){b.notes=c;b.database.person.getAllPeople(false,false,function(d){b.people=
d.sort(function(e,f){if(e.name===f.name)return-1;if(e.name>f.name)return 1;return-1});a()})})},showPopup:function(a){jQuery("#"+a).show();jQuery("#container, header").css("opacity",0.2)},hidePopup:function(){jQuery(".popup").hide();jQuery("#container, header").css("opacity",1)},getStartingTab:function(){var a=this.getLocationHash();(a=a.length>1?this.getTabForTabName(a):this.tabs[0])||(a=this.tabs[0]);return a},setLocationFromGeocode:function(a,b){this.currentLocation={lat:a.geometry.location.lat(),
lng:a.geometry.location.lng(),qlat:b.lat(),qlng:b.lng(),name:a.formatted_address,type:a.type};jQuery(".location_input select").prepend("<option>"+Atomate.currentLocation.name+"</option>")},addNotes:function(a){var b=this;a&&jQuery.fn.append.apply(this.notesList,a.map(function(c){return b.templates.getItemHtml(c)}))}};Atomate.util={parent:Atomate,getCurrentLocation:function(a,b){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(c){c&&c.coords?jQuery.getJSON("http://maps.googleapis.com/maps/api/geocode/json",{latlng:[c.coords.latitude,c.coords.longitude],sensor:"true"},function(d){console.log(d);a(location)}):b(c)},b):b("not supported")},log:function(a){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect")}catch(b){}Components.classes["@mozilla.org/consoleservice;1"].getService(Components.interfaces.nsIConsoleService).logStringMessage();
return a},map:function(a,b){var c=[];if(b===undefined)return c;for(var d=0;d<b.length;d++)c.push(a(b[d],d));return c},filterUndefined:function(a){return a.filter(function(b){return b!==undefined})},multimap:function(){var a=arguments[0],b=this.arguments2array(arguments).slice(1),c=[];if(b.length===0)return c;for(var d=0;d<b[0].length;d++)c.push(a.apply(undefined,b.map(function(e){return e[d]})));return c},mapappend:function(a,b){var c=[];b.map(function(d){c.splice.apply(c,[c.length,0].concat(a(d)))});
return c},mapsum:function(a,b){if(b.length==0)return 0;return b.map(a).reduce(function(c,d){if(!d)return c;return c+d})},sum:function(a){return a.reduce(function(b,c){if(!c)return b;return b+c})},and:function(a,b){return b===undefined?a:a&&b},scriptLoadCB:function(a,b,c,d){if(self.__scriptload_cb===undefined)self.__scriptload_cb={};if(self.__subscript_callback===undefined)self.__defn_module=function(f,g){return self.__scriptload_cb[f](g)};d=d||self.document;var e=d.createElement("script");e.setAttribute("type",
"text/javascript");e.setAttribute("src",a);self.__scriptload_cb[b]=c;d.getElementsByTagName("BODY")[0].appendChild(e);return e},scriptLoad:function(a,b){var c=b||self.document,d=c.createElement("script");d.setAttribute("type","text/javascript");d.setAttribute("src",a);c.getElementsByTagName("BODY")[0].appendChild(d);return d},subload:function(a,b){try{try{netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect")}catch(c){}return Components.classes["@mozilla.org/moz/jssubscript-loader;1"].getService(Components.interfaces.mozIJSSubScriptLoader).loadSubScript(a,
b)}catch(d){this.log(d)}},shallowCopy:function(a){var b={},c;for(c in a)b[c]=a[c];return b},filter:function(a,b){var c=[];if(b===undefined)return c;for(var d=0;d<b.length;d++)a(b[d])&&c.push(b[d]);return c},isValidEmail:function(a){return a!==undefined&&a!==null&&a.indexOf("@")>0},object:function(a){var b=function(){};b.prototype=a;return new b},diff:function(a,b){for(var c={},d={},e=0;e<a.length;e++){if(c[a[e]]==null)c[a[e]]={rows:[],o:null};c[a[e]].rows.push(e)}for(e=0;e<b.length;e++){if(d[b[e]]==
null)d[b[e]]={rows:[],n:null};d[b[e]].rows.push(e)}for(e in c)if(c[e].rows.length==1&&typeof d[e]!="undefined"&&d[e].rows.length==1){a[c[e].rows[0]]={text:a[c[e].rows[0]],row:d[e].rows[0]};b[d[e].rows[0]]={text:b[d[e].rows[0]],row:c[e].rows[0]}}for(e=0;e<a.length-1;e++)if(a[e].text!=null&&a[e+1].text==null&&a[e].row+1<b.length&&b[a[e].row+1].text==null&&a[e+1]==b[a[e].row+1]){a[e+1]={text:a[e+1],row:a[e].row+1};b[a[e].row+1]={text:b[a[e].row+1],row:e+1}}for(e=a.length-1;e>0;e--)if(a[e].text!=null&&
a[e-1].text==null&&a[e].row>0&&b[a[e].row-1].text==null&&a[e-1]==b[a[e].row-1]){a[e-1]={text:a[e-1],row:a[e].row-1};b[a[e].row-1]={text:b[a[e].row-1],row:e-1}}return{o:b,n:a}},keys:function(a){var b=[],c;for(c in a)b.push(c);return b},dictzip:function(a,b){var c={};this.multimap(function(d,e){c[d]=e},a,b);return c},ls:function(a){var b="",c;for(c in a)b+=c+", ";return b},isFunction:function(a){return typeof a=="function"},export_fns:function(a){for(var b in a)self[b]=a[b]},curry:function(a){for(var b=
[],c=1,d=arguments.length;c<d;++c)b.push(arguments[c]);return function(){a.apply(null,b)}},curryscope:function(a,b){for(var c=[],d=2,e=arguments.length;d<e;++d)c.push(arguments[d]);return function(){a.apply(b,c)}},_spaces:function(a){for(var b="",c=0;c<a;c++)b+=" ";return b},isArrayLike:function(){for(var a=0;a<arguments.length;a++){var b=arguments[a],c=typeof b;if(c!="object"&&!(c=="function"&&typeof b.item=="function")||b===null||typeof b.length!="number")return false}return true},isDateLike:function(){for(var a=
0;a<arguments.length;a++){var b=arguments[a];if(typeof b!="object"||b===null||typeof b.getTime!="function")return false}return true},assert:function(a,b){if(!a)throw Error("(Assertion Error): "+b);return true},isIterable:function(a){try{iter(a);return true}catch(b){return false}},regexp_g:function(a,b,c){c||(c=0);for(var d,e=[];(d=a.exec(b))!==null;)e.push(d[c]);return e},partial:function(a){return this.bind.apply(this,this.extend([a,undefined],arguments,1))},bind:function(a,b){if(typeof a=="string")a=
b[a];var c=a.im_func,d=a.im_preargs,e=a.im_self,f=this;if(typeof a=="function"&&typeof a.apply=="undefined")a=f._wrapDumbFunction(a);if(typeof c!="function")c=a;if(typeof b!="undefined")e=b;d=typeof d=="undefined"?[]:d.slice();f.extend(d,arguments,2);var g=function(){var h=arguments,i=arguments.callee;if(i.im_preargs.length>0)h=f.concat(i.im_preargs,h);var j=i.im_self;j||(j=this);return i.im_func.apply(j,h)};g.im_self=e;g.im_func=c;g.im_preargs=d;return g},extend:function(a,b,c){c||(c=0);if(b){var d=
b.length;if(typeof d!="number")throw new TypeError("Argument not an array-like ");for(a||(a=[]);c<d;c++)a.push(b[c])}return a},flatten:function(a){for(var b=[],c=0,d=a.length;c<d;c++){var e=Object.prototype.toString.call(a[c]).split(" ").pop().split("]").shift().toLowerCase();if(e)b=b.concat(/^(array|collection|arguments|object)$/.test(e)?flatten(a[c]):a[c])}return b},concat:function(){for(var a=[],b=this.extend,c=0;c<arguments.length;c++)b(a,arguments[c]);return a},load:function(a){var b=document.createElement("script");
b.type="text/javascript";b.src=a;document.getElementsByTagName("head")[0].appendChild(b)},strRemoved:function(a,b){return a.split(b).join("")},remove_dups:function(a){var b={},c;for(c in a)b[a[c]]=true;a=[];for(var d in b)a.push(d);return a},obj2str:function(a,b,c){if(!typeof a==="object")return""+a;c||(c=0);var d="",e;for(e in a){var f=a[e];d=typeof f==="object"&&b?d+this.obj2str(f,b,c+5)+"\n":d+this._spaces(c)+e+": "+f+"\n"}return d},guid:function(a){a||(a=12);for(var b="",c=0;c<a;c++)b+="abcdefghijklmnopqrstuvwxyz1234567890"[Math.floor(36*
Math.random())];return b},copy_bindings:function(a,b){for(var c in a)b[c]=a[c];return b},arguments2array:function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c]);return b},map_append:function(){var a=this,b=this.arguments2array(arguments),c=b[0];b=b.slice(1,b.length);var d=[],e=[function(){var f=c.apply(null,a.arguments2array(arguments));d=d.concat(f)}];e=e.concat(b);this.map.apply(null,e);return d},makeIterable:function(a){return this.isIterable(a)?list(a):[a]},intersection:function(){var a=this.arguments2array(arguments);
if(a.length>2)return intersection(a[0],intersection.apply(null,a.slice(1,a.length)));var b=this.remove_dups(a[0]),c=this.remove_dups(a[1]);return this.filter(function(d){return c.indexOf(d)>=0},b)},date_intersection:function(a,b,c,d){return Math.max(0,-Math.max(a,c)+Math.min(b,d))},filterForEnter:function(a){return function(b){var c=b.charCode?b.charCode:b.which?b.which:b.keyCode;if(c==13||c==3){a(b);return false}return true}},wrap_access_counts:function(a){function b(e){var f={_accesses:0};if(typeof e!==
"object")return e;for(var g in e)f.__defineGetter__(g,function(h){return function(){this._accesses+=1;return h}}(e[g]));return f}var c=[],d;for(d in a)c.push(b(a[d]));return c},convert_strings:function(a){function b(e){var f={};if(typeof e==="string")return new String(e);if(typeof e!=="object")return e;for(var g in e)f[g]=b(e[g]);return f}var c=[],d;for(d in a)c.push(b(a[d]));return c},urlencode:function(a){a=a.toString();a=encodeURIComponent(a);return a=a.replace(/%20/g,"+")},accumulate_and:function(a,
b){for(var c=0;c<a.length;c++)if(!b(a[c]))return false;return true},fillArray:function(a,b){for(var c=0;c<b;c++)(0).push(a);return 0},intRange:function(a,b){for(var c=[],d=a;d<b;d++)c.push(d);return c},objFilter:function(a,b){var c={},d;for(d in b){var e=b[d];if(a(e))c[d]=e}return c},objmap:function(a,b,c){var d={},e=function(f){return f};if(a===undefined)a=e;if(b===undefined)b=e;this.keys(c).map(function(f){d[a(f)]=b(c[f])});return d},unzipdict:function(a){return this.keys(a).map(function(b){return[b,
a[b]]})},objMap:function(a,b){var c={},d;for(d in b)c[d]=a(b[d]);return c},objKeys:function(a){var b=[],c;for(c in a)b.push(c);return b},objVals:function(a){var b=[],c;for(c in a)b.push(a[c]);return b},clone:function(a,b,c){if(b===undefined)b={};for(var d in a)if(c===undefined||c.indexOf(d)<0)b[d]=a[d];return b},getNSPrefsBranch:function(a){a=Components.classes["@mozilla.org/preferences-service;1"].getService(Components.interfaces.nsIPrefService).getBranch(a);a.QueryInterface(Components.interfaces.nsIPrefBranch);
return a},consolelogger:function(){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect")}catch(a){}var b=Components.classes["@mozilla.org/consoleservice;1"].getService(Components.interfaces.nsIConsoleService);return function(c){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect")}catch(d){}b.logStringMessage(c)}},keyCompare:function(a,b,c){if(c===undefined)c=function(e,f){return e==f};var d=this.objKeys(a);return d.map(function(e){return c(a[e],b[e]).filter(function(f){return f}).length==
d.length})},uniq_slow:function(a,b){for(var c=[],d=[],e=0;e<a.length;e++){var f=b===undefined?a[e]:b(a[e]);if(d.indexOf(f)<0){d.push(f);c.push(a[e])}}return c},union:function(a,b,c){if(a===undefined)return b;if(b===undefined)return a;return this.uniq(a.concat(b),c)},uniq_fast:function(a,b){for(var c={},d=0;d<a.length;d++){var e=b===undefined?a[d]:b(a[d]);c[e]=a[d]}return this.objVals(c)},uniq:function(a,b){this.assert(this.isArrayLike(a),"arg to uniq() must be arraylike");if(a===undefined||a.length==
0)return a;if(b!==undefined&&typeof b(a[0])=="string"||typeof a[0]=="string"||typeof a[0]=="number")return this.uniq_fast(a,b);return this.uniq_slow(a,b)},make_base_auth:function(a,b){return"Basic "+this.Base64.encode(a+":"+b)},crypto_hash:function(a){function b(f){return("0"+f.toString(16)).slice(-2)}try{netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect")}catch(c){}if(this.__converter==undefined){this.__converter=Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
this.__converter.charset="UTF-8"}a=this.__converter.convertToByteArray(a,{});var d=Components.classes["@mozilla.org/security/hash;1"].createInstance(Components.interfaces.nsICryptoHash);d.init(d.MD5);d.update(a,a.length);a=d.finish(false);d=[];for(var e in a)d.push(b(a.charCodeAt(e)));return d.join("")},hash:function(a,b){if(a!==undefined){if(b===undefined)b=10;return this.crypto_hash(a).slice(0,b)}},interval_map:function(a,b,c,d,e){var f=[];c=c||function(){};var g=a.concat(),h=undefined,i=function(){if(h){clearInterval(h);
h=undefined}};h=setInterval(function(){if(g.length==0){i();c(f)}else{var j=g.shift();try{f.push(b(j))}catch(l){console.log(l)}}},e!==undefined?e:100);return{running:function(){return h==undefined},stop:i,results:f}},firstKey:function(a){for(var b in a)return b},extendDate:function(a){a.isToday=function(b){return this.midnightOf()==b.midnightOf()};a.noonOf=function(){return this.topOfHourOf(12)};a.plusDays=function(b){return new Date(this.valueOf()+b*864E5)};a.onOrBefore=function(b){return this.valueOf()<=
b.valueOf()};a.midnightOf=function(){return this.topOfHourOf(0)};a.topOfHourOf=function(b){var c=new Date(this.valueOf());c.setHours(b);c.setMinutes(0);c.setSeconds(0);c.setMilliseconds(0);return c}},isSameDay:function(a,b){return this.midnightOf(a)==this.midnightOf(b)},noonOf:function(a){return this.topOfHourOf(a,12)},plusDays:function(a,b){return new Date(a.valueOf()+b*864E5)},onOrBefore:function(a,b){return a.valueOf()<=b.valueOf()},midnightOf:function(a){return this.topOfHourOf(a,0)},topOfHourOf:function(a,
b){var c=new Date(a.valueOf());c.setHours(b);c.setMinutes(0);c.setSeconds(0);c.setMilliseconds(0);return c},removeIndices:function(a,b,c){c=a.slice((c||b)+1||a.length);a.length=b<0?a.length+b:b;return a.push.apply(a,c)},removeElement:function(a,b){var c=a.indexOf(b);if(c>=0)return this.removeIndices(a,c,c);return a},elementRemoved:function(a,b){a=a.concat();for(var c=a.indexOf(b);c>=0;){a=a.slice(0,c).concat(a.slice(c+1));c=a.indexOf(b)}return a},elementsRemoved:function(a,b){var c=this;b.map(function(d){a=
c.elementRemoved(a,d)});return a},applyTemplate:function(a,b){var c=b+"";for(k in a)c=c.replace(RegExp("\\$"+k,"g"),a[k]);return c},printObj:function(a){if(typeof a=="string")return a;if(typeof a=="object"){var b=function(c){if(typeof c=="function")return"<function>";return c};return this.toJSON(this.isArrayLike(a)?a.map(b):this.objMap(b,a))}return a.toString()},toJSON:function(a){try{return JSON.stringify(a)}catch(b){}try{netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect")}catch(c){}if(a===
undefined)return"undefined";var d=Components.classes["@mozilla.org/dom/json;1"].createInstance(Components.interfaces.nsIJSON).encode(a);if(d!==undefined&&d!==null)return d.replace(/,\]/g,"]");else{this.FAILBOMB=a;throw Error("FAILURE trying to json-encode : "+a);}},fromJSON:function(a){try{return JSON.parse(a)}catch(b){}try{netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect")}catch(c){}var d=Components.classes["@mozilla.org/dom/json;1"].createInstance(Components.interfaces.nsIJSON);
try{return d.decode(a)}catch(e){if(typeof e=="object")e="error "+e.fileName+":"+e.lineNumber+":: "+e.message+" "+e.stack;dump(e+"\n")}},fromJSONAggressive:function(a){function b(f){if(typeof f!=="string")return f;var g=f;try{g=e.decode(f)}catch(h){return f}if(d.isArrayLike(g))return g.map(b);if(typeof g=="object")return d.objMap(b,g);return g}try{netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect")}catch(c){}var d=this,e=Components.classes["@mozilla.org/dom/json;1"].createInstance(Components.interfaces.nsIJSON);
return b(a)},AssertAbstract:function(){this.assert(false,"Thsi method is abstract")},extendArray:function(a){a.remove=function(b,c){var d=this.slice((c||b)+1||this.length);this.length=b<0?this.length+b:b;return this.push.apply(this,d)};a.maxIndex=function(){if(this.length==0)return-1;for(var b=0,c=1;c<this.length;c++)if(this[c]>this[b])b=c;return b};a.sum=function(){if(this.length==0)return 0;for(var b=0,c=0;c<this.length;c++)b+=this[c];return b};a.uniq=function(){for(var b=[],c=0;c<this.length;c++)b.indexOf(this[c])<
0&&b.push(this[c]);return b}},dict:function(a){var b={};a.map(function(c){b[c[0]]=c[1]});return b},xmldoc2string:function(a){return(new XMLSerializer).serializeToString(a)},indexAll:function(a,b,c,d){var e=[];if(a===undefined)return e;if(c===undefined)c=0;if(d==undefined)d=a.length;for(c=a.indexOf(b,c);c>=0&&c<=d;){e.push(c);c=a.indexOf(b,c+1)}return e},trim:function(a){if(a.trim)return a.trim();return this.str_trim(a)},str_trim:function(a){if(a===null||a===undefined)return a;return a.replace(/^\s+|\s+$/g,
"")},str_ltrim:function(a){if(a===null||a===undefined)return a;return a.replace(/^\s+/,"")},str_rtrim:function(a){if(a===null||a===undefined)return a;return a.replace(/\s+$/,"")},replaceAll:function(a,b,c){for(var d=0;d>=0;){d=a.indexOf(b,d+c.length);a=a.substring(0,d)+a.substring(d).replace(b,c)}return a},dateISO8601:function(a){a=a.match(RegExp("([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?"));var b=0,c=new Date(a[1],
0,1);a[3]&&c.setMonth(a[3]-1);a[5]&&c.setDate(a[5]);a[7]&&c.setHours(a[7]);a[8]&&c.setMinutes(a[8]);a[10]&&c.setSeconds(a[10]);a[12]&&c.setMilliseconds(Number("0."+a[12])*1E3);if(a[14]){b=Number(a[16])*60+Number(a[17]);b*=a[15]=="-"?1:-1}b-=c.getTimezoneOffset();time=Number(c)+b*6E4;a=new Date;a.setTime(Number(time));return a},RGBToHSB:function(a){var b={h:0,s:0,b:0};b.b=Math.max(Math.max(a.r,a.g),a.b);b.s=b.b<=0?0:Math.round(100*(b.b-Math.min(Math.min(a.r,a.g),a.b))/b.b);b.b=Math.round(b.b/255*100);
b.h=a.r==a.g&&a.g==a.b?0:a.r>=a.g&&a.g>=a.b?60*(a.g-a.b)/(a.r-a.b):a.g>=a.r&&a.r>=a.b?60+60*(a.g-a.r)/(a.g-a.b):a.g>=a.b&&a.b>=a.r?120+60*(a.b-a.r)/(a.g-a.r):a.b>=a.g&&a.g>=a.r?180+60*(a.b-a.g)/(a.b-a.r):a.b>=a.r&&a.r>=a.g?240+60*(a.r-a.g)/(a.b-a.g):a.r>=a.b&&a.b>=a.g?300+60*(a.r-a.b)/(a.r-a.g):0;b.h=Math.round(b.h);return b},HSBToRGB:function(a){var b={},c=Math.round(a.h),d=Math.round(a.s*255/100);a=Math.round(a.b*255/100);if(d==0)b.r=b.g=b.b=a;else{d=(255-d)*a/255;var e=(a-d)*(c%60)/60;if(c==360)c=
0;if(c<60){b.r=a;b.b=d;b.g=d+e}else if(c<120){b.g=a;b.b=d;b.r=a-e}else if(c<180){b.g=a;b.r=d;b.b=d+e}else if(c<240){b.b=a;b.r=d;b.g=a-e}else if(c<300){b.b=a;b.g=d;b.r=d+e}else if(c<360){b.r=a;b.g=d;b.b=a-e}else{b.r=0;b.g=0;b.b=0}}return{r:Math.round(b.r),g:Math.round(b.g),b:Math.round(b.b)}},edit_distance:function(a,b){var c=function(j,l,m){if(j<l&&j<m)return j;if(l<j&&l<m)return l;return m},d,e=a.length,f=b.length;if(e<f){d=a;a=b;b=d;var g=e;e=f;f=g}g=[];g[0]=[];for(d=0;d<f+1;d++)g[0][d]=d;for(var h=
1;h<e+1;h++){g[h]=[];g[h][0]=h;for(var i=1;i<f+1;i++){d=a.charAt(h-1)==b.charAt(i-1)?0:1;g[h][i]=c(g[h-1][i]+1,g[h][i-1]+1,g[h-1][i-1]+d)}}return g[e][f]},getNaturalDate:function(a){if(isNaN(a))return"";return(new Date(a)).format("ddd, mmmm dS h:MM TT")}};
Atomate.util.Base64={pu:Atomate.util,_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){var b="",c,d,e,f,g,h,i=0;for(a=this.pu.Base64._utf8_encode(a);i<a.length;){c=a.charCodeAt(i++);d=a.charCodeAt(i++);e=a.charCodeAt(i++);f=c>>2;c=(c&3)<<4|d>>4;g=(d&15)<<2|e>>6;h=e&63;if(isNaN(d))g=h=64;else if(isNaN(e))h=64;b=b+this._keyStr.charAt(f)+this._keyStr.charAt(c)+this._keyStr.charAt(g)+this._keyStr.charAt(h)}return b},decode:function(a){var b="",c,d,e,f,g,h=
0;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");h<a.length;){c=this._keyStr.indexOf(a.charAt(h++));d=this._keyStr.indexOf(a.charAt(h++));f=this._keyStr.indexOf(a.charAt(h++));g=this._keyStr.indexOf(a.charAt(h++));c=c<<2|d>>4;d=(d&15)<<4|f>>2;e=(f&3)<<6|g;b+=String.fromCharCode(c);if(f!=64)b+=String.fromCharCode(d);if(g!=64)b+=String.fromCharCode(e)}return b=this.pu.Base64._utf8_decode(b)},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);if(d<128)b+=
String.fromCharCode(d);else{if(d>127&&d<2048)b+=String.fromCharCode(d>>6|192);else{b+=String.fromCharCode(d>>12|224);b+=String.fromCharCode(d>>6&63|128)}b+=String.fromCharCode(d&63|128)}}return b},_utf8_decode:function(a){for(var b="",c=0,d=0,e=0,f=0;c<a.length;){d=a.charCodeAt(c);if(d<128){b+=String.fromCharCode(d);c++}else if(d>191&&d<224){e=a.charCodeAt(c+1);b+=String.fromCharCode((d&31)<<6|e&63);c+=2}else{e=a.charCodeAt(c+1);f=a.charCodeAt(c+2);b+=String.fromCharCode((d&15)<<12|(e&63)<<6|f&63);
c+=3}}return b}};Atomate.detector={parent:Atomate,initialize:function(){},isNote:function(){},isTodo:function(a){return a.substring(0,4).toLowerCase()=="todo"},isNote:function(){},containsUrl:function(a){var b=false;a.map(function(c){if(Atomate.validator.isValidUrl(c))b=true});return b},isWebsite:function(a,b){return containsUrl(b)},isReminder:function(a){return a.substring(0,9).toLowerCase()=="remind me"}};Atomate.validator={parent:Atomate,isValidEmail:function(a){return/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i.test(a)},
isValidUrl:function(a){return/^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(a)},
isValidCreditCard:function(a){a=a.split(" ").join("");if(a===undefined||a.length<1||a.length>19)return false;a=Util.reverse(String(a));var b=0,c=0;c="";for(var d=0;d<a.length;d++){if(d%2){c=a.substr(d,1)*2;if(c>=10){c=String(c);c=parseInt(c.substr(0,1),10)+parseInt(c.substr(1,1),10)}}else c=a.substr(d,1);b+=parseInt(c,10)}return b%10?false:true},isValidYear:function(a){return/^[12][890][0-9][0-9]$/.test(a)},isValidName:function(a){return/^[\w ]+$/i.test(a)},isNumeric:function(a){String(a).replace("\n",
"").replace("\r","").replace("\t","").replace(" ","");return a-0==a&&a.length>0},isValidNumber:function(a){return this.isNumeric(a)},isValidFbid:function(a){return this.isNumeric(a)},isValidInternationalNumber:function(a){return/^\+(?:[0-9] ?){6,14}[0-9]$/.test(a)},isValidPhoneNumber:function(a){return/^(?:\+?1[-. ]?)?\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/.test(a)},isAlphanumeric:function(a){return/^\w+$/i.test(a)}};Atomate.tracking={parent:Atomate,initialize:function(a){var b=this,c=a.trackingmodule,d=a.mixPanelInit;if(c&&d){this.trackAction=function(f,g,h){c.push(["track",f,g]);h&&h()};this.trackActionSYNC=function(f,g,h){if(!b.mixPanel)b.mixPanel=d();b.mixPanel.track(f,g,h)};this.trackFunnel=function(f,g){c.push(["track",f,g])};this.registerUser=function(f){f.id&&c.push(["identify",f.id]);c.push(["register",{"signed in":f.signedIn,gender:f.gender,"age group":f.ageGroup}])};if(!a.doNotTrackPageload){var e=
window.location?window.location.pathname:"";this.registerUser({id:a.userId,gender:a.userGender,ageGroup:a.userAgeGroup,signedIn:a.signedIn});c.push(["track","Page Load",{location:e}])}this.initialized=true}}};Atomate.templates={parent:Atomate,getItemHtml:function(a){return a.type?a.type=="person"?this.getPersonHtml(a):this.getNoteHtml(a):this.getNoteHtml(a)},getCustomSearchHtml:function(a){return'<li class="custom_search"><div class="text">Searching for: <b>'+a+'</b> <a class="remove_custom_search">remove</a></div></li>'},linkifyNote:function(a){a=a.replace(/((https?\:\/\/)|(www\.))(\S+)(\w{2,4})(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/gi,function(b){var c=b;c.match("^https?://")||(c="http://"+c);return'<a href="'+
c+'" target="_blank">'+b+"</a>"});a=a.replace(/(^|\s)@(\w+)/g,'$1<a class="at_link" data-id="@$2">@$2</a>');return a.replace(/(^|\s)#(\w+)/g,'$1<a class="hash_link" data-id="#$2">#$2</a>')},getPersonPhotoUrl:function(a){if(a.fbid)return"http://graph.facebook.com/"+a.fbid+"/picture?type=square"},getTabName:function(a){if(a.name=="+")return"plus";return a.name.toLowerCase()},getTabHtml:function(a,b,c){if(a&&a.name!==undefined)return'<li data-type="'+a.type+'" data-name="'+this.getTabName(a)+'" class="tab_'+
this.getTabName(a)+(b.name.toLowerCase()==a.name.toLowerCase()?" selected":"")+'"><a href="#'+a.name.toLowerCase()+'">'+a.name+"</a>"+(c?'<img class="remove" src="../img/remove.png" />':"")+"</li>"},getItemType:function(a){return a.toLowerCase().replace("schemas.","")},getActionsHtml:function(){return'<div class="actions"><img class="item_remove" src="../img/remove.png" /><img class="item_edit" src="../img/settings_16.png" /></div>'},getPersonHtml:function(a){return'<li class="type_'+this.getItemType(a.type)+
'">'+this.getActionsHtml(a)+'<img class="profile_photo" src="'+a.photourl+'" /><div class="text"><a class="at_link" data-id="'+a.tag+'">'+a.name+"</a>"+(a.fbid?'<br /><a class="external" href="http://www.facebook.com/profile.php?id='+a.fbid+'" target="_blank">Facebook</a>':"")+"</div></li>"},getNoteEditorHtml:function(a,b,c){return'<div class="note_input" data-id="'+a+'"><textarea rows="1" cols="52">'+b+'</textarea><div class="controls clearfix"><input type="submit" value="Save" class="notes_save_btn" /><div class="location_input"><label>Location:</label><select><option val="none">None</option></select><label>Time:</label><input type="text" placeholder="6/25/2011" class="picker_date" value="'+
(c?c.format("m/dd/yy"):"")+'" /><input type="text" placeholder="10:30pm" class="picker_time" value="'+(c?c.format("h:MM TT"):"")+'" /></div></div></div>'},_getNoteHtml:function(a){return this.getActionsHtml(a)+'<div class="text">'+this.linkifyNote(a.contents)+'</div><div class="context">'+(a.location?'<span class="context_item location"><img src="../img/location.png" />'+a.location+"</span>":"")+(a.reminder?'<span class="context_item date" data-val="'+a.reminder+'"><img src="../img/calendar.png" />'+
this.parent.util.getNaturalDate(a.reminder)+"</span>":"")+(a.type&&a.type!=="note"&&a.type!=="event"?"<span>"+a.type+"</span>":"")+"</div>"},getNoteHtml:function(a){return'<li id="note_'+a.jid+'" class="note type_'+this.getItemType(a.type)+'">'+this._getNoteHtml(a)+"</li>"}};Atomate.autocomplete={parent:Atomate,initialize:function(){var a=this.parent.people.map(function(c){return c.tag}),b=this.parent.notes.map(function(c){return c.tags.split(" ")});b=b.length>0?b.reduce(function(c,d){return c.concat(d)}):[];this.data=this.parent.util.uniq(a.concat(b));this.autocompleteDiv=this.setupAutocompleteDiv(this.parent.searchDiv,this.setAutocompleteVal)},setupAutocompleteDiv:function(a){var b=this;return a.bind("keydown",function(c){c.keyCode===$.ui.keyCode.TAB&&$(this).data("autocomplete").menu.active&&
c.preventDefault()}).autocomplete({minLength:3,source:function(c,d){var e=c.term,f=[];if(e.indexOf("@")>=0||e.indexOf("#")>=0)if((e=c.term.split(" ").pop())&&e.length>0&&(e.indexOf("@")==0||e.indexOf("#")==0))f=jQuery.ui.autocomplete.filter(b.data,e);d(f)},focus:function(){return false},select:function(c,d){var e=this.value.split(" ");e.pop();e.push(d.item.value);e.push("");this.value=e.join(" ");return false}})}};Atomate.noteEdit={parent:Atomate,initialize:function(){this.setupEventListeners()},setupEventListeners:function(){var a=this;jQuery(".notes_save_btn").live("click",function(b){b.stopPropagation();var c=jQuery(this).parent().parent(),d=c.attr("data-id"),e=c.find("textarea").val().trim();b=(new Date).valueOf();var f=a.getDateForNoteCreationDateTime(c.find(".picker_date").val(),c.find(".picker_time").val()),g=a.getNoteType(e),h=a.getTagsForNote(e);c.attr("id")=="input"?a.parent.database.notes.addNewNote(b,
e,h,g,f,function(i){a.parent.database.notes.getNoteById(i,function(j){a.parent.notes.push(j);c.find('textarea, input[type="text"]').val("");a.appendNote(j,true)})}):a.parent.database.notes.getNoteById(d,function(i){a.parent.database.notes.editNote(d,i.version++,i.created,(new Date).valueOf(),0,e,i.modified++,h,g,f,i.source,function(j){a.appendNote(j,false);a.replaceNoteInLocalCache(j)})})})},replaceNoteInLocalCache:function(a){this.parent.notes=this.parent.notes.map(function(b){if(a.jid===b.jid)b=
a;return b})},getNoteType:function(a){a=a.toLowerCase();return a.indexOf("remind me")>-1?"reminder":a.indexOf("http://")>-1?"bookmark":a.indexOf("todo")>-1?"todo":"note"},getDateForNoteCreationDateTime:function(a,b){try{return Date.parse(a+" "+b)}catch(c){debug(c);return 0}},getTagsForNote:function(a){return(a=a.toLowerCase().match(/[#]+[A-Za-z0-9-_]+/g))?a.join(" "):""},createNoteEditor:function(a,b,c,d,e){a.html(this.parent.templates.getNoteEditorHtml(b,c,d,e))},editNote:function(a){a=jQuery(a);
var b=a.attr("id").replace("note_","").replace("#",""),c=a.find(".text").text(),d=a.find(".location").text(),e=parseInt(a.find(".date").attr("data-val"),10);e=e?new Date(e):undefined;this.createNoteEditor(a,b,c,e,d)},appendNote:function(a,b){if(b){var c=this.parent.templates.getNoteHtml(a);this.parent.notesList.prepend(c)}else{c=this.parent.templates._getNoteHtml(a);jQuery("#note_"+a.jid).html(c)}}};Atomate.database={parent:Atomate,DB:null,initialize:function(){try{this.createPersonDB();this.createNoteDB()}catch(a){console.log(a)}},clearDB:function(){this.clearNoteDB();this.clearPersonDB()},clearNoteDB:function(){this._clearDB("note","CREATE TABLE note ("+this.notes.schema+")")},createNoteDB:function(){this._createDB("CREATE TABLE IF NOT EXISTS note ("+this.notes.schema+")")},clearPersonDB:function(){this._clearDB("person","CREATE TABLE person ("+this.person.schema+")")},createPersonDB:function(){this._createDB("CREATE TABLE IF NOT EXISTS person ("+
this.person.schema+")")},_clearDB:function(a,b){this.DB.transaction(function(c){c.executeSql("DROP TABLE "+a,[]);c.executeSql(b,[])})},_createDB:function(a){if(window.Components){this.setupFirefoxDB();this.isFirefox=true}this.DB=this.DB||openDatabase("Atomate","","Atomate",5E6);this.DB.transaction(function(b){b.executeSql(a,[])})},_getUniqueJID:function(a,b){var c=this,d=Math.floor(Math.random()*1E6);this.DB.transaction(function(e){e.executeSql("SELECT * FROM "+a+" WHERE jid=? LIMIT 1",[d],function(f,
g){g.rows.length===1?c.getUniqueJID(b):b(d)},function(f,g){console.log("Unsuccessful get");console.log(g);b(d)})})},setupFirefoxDB:function(){var a=this;netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");var b=Components.classes["@mozilla.org/file/directory_service;1"].getService(Components.interfaces.nsIProperties).get("ProfD",Components.interfaces.nsIFile);b.append("Atomate_001.sqlite");this._DB=Components.classes["@mozilla.org/storage/service;1"].getService(Components.interfaces.mozIStorageService).openDatabase(b);
this.DB={};this.DB.transaction=function(c){return c(a.DB)};this.DB.executeSql=function(c,d,e){d&&d.map(function(h){c=parseInt(h,10)?c.replace("?",h):c.replace("?",'"'+h+'"')});e||(e=function(){});netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");var f=a._DB.createStatement(c),g=false;return f.executeAsync({handleResult:function(h){var i={rows:{item:[],length:0}},j=0,l,m,n,o;netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");for(l=h.getNextRow();l;l=h.getNextRow()){i.rows.item[j]=
{};for(m=0;m<l.numEntries;m++){n=f.getColumnName(m);o=l.getResultByIndex(m);i.rows.item[j][n]=o}j++;i.rows.length=j}g=true;e(f,i)},handleError:function(h){console.log(h+" << error");debug(h)},handleCompletion:function(h){h!=Components.interfaces.mozIStorageStatementCallback.REASON_FINISHED&&debug("Query canceled or aborted!");g||e(f,{rows:{item:[],length:0}})}})}}};Atomate.database.notes={parent:Atomate.database,schema:"jid INT PRIMARY KEY, version INT, created INT, edited INT, deleted INT, contents TEXT, tags TEXT, type TEXT, reminder INT, source TEXT",properties:"(jid, version, created, edited, deleted, contents, tags, type, reminder, source)",values:"(?,?,?,?,?,?,?,?,?,?)",addNote:function(a,b,c,d,e,f){this.parent.DB.transaction(function(g){var h=0,i=i,j=parseInt(j,10),l=parseInt(l,10);if(e===1||e===true||e==="true")h=1;g.executeSql("INSERT INTO note VALUES"+
this_.values+";",[i,b,j,l,h,f,0,tags,type,reminder,source],function(){debug("NOTE INSERT - note DB")})})},addNewNote:function(a,b,c,d,e,f){var g=this;this.parent._getUniqueJID("note",function(h){g.parent.DB.transaction(function(i){i.executeSql("INSERT INTO note "+g.properties+" VALUES"+g.values+";",[h,0,a,a,0,b,c,d,e,"Atomate"],function(){debug("NOTE INSERT - note DB")})});f(h)})},editNote:function(a,b,c,d,e,f,g,h,i,j,l){debug("Updating note in database: "+a);debug(c);debug(d);var m=this;this.parent.DB.transaction(function(n){n.executeSql("INSERT OR REPLACE INTO note "+
m.properties+" VALUES"+m.values+";",[a,b,c,d,e,f,g,h,i,j],function(){l!==undefined&&m.getNoteById(a,l);debug("SUCCESSFUL NOTE UPSERT to DB")})})},deleteNote:function(a){var b=this;this.getNoteById(a,function(c){c!==null&&b.parent.DB.transaction(function(d){d.executeSql("INSERT OR REPLACE INTO note "+b.properties+" VALUES"+b.values+";",[a,c.version,c.created,c.edited,1,c.contents,1,c.tags,c.type,c.reminder,c.source],function(){debug("DB: note-delete success")})})})},getNoteById:function(a,b){this.parent.DB.transaction(function(c){c.executeSql("SELECT * FROM note WHERE jid=? LIMIT 1",
[a],function(d,e){if(e.rows.length===1){var f=jQuery.isArray(e.rows.item)?e.rows.item[0]:e.rows.item(0);b(f)}else b(null)},function(d,e){debug("Unsuccessful get");debug(e);b(null)})})},getAllNotes:function(a,b,c){this.parent.DB.transaction(function(d){d.executeSql("SELECT * FROM note WHERE deleted = ? ORDER BY created DESC",[a?1:0],function(e,f){debug("DB: Starting to grab notes");for(var g=[],h=jQuery.isArray(f.rows.item),i=0;i<f.rows.length;i++){var j=h?f.rows.item[i]:f.rows.item(i);j.jid===-1&&
!b||g.push({jid:j.jid,contents:j.contents,tags:j.tags,type:j.type||"note",edited:j.edited,reminder:j.reminder})}debug("DB: Finished grabbing notes.");c(g)})})},putAllNotesInDB:function(a){var b="INSERT OR REPLACE INTO note "+this.properties+" VALUES"+this.values+";";a=a.map(function(c){var d=0;if(c.deleted===true||c.deleted==="true"||c.deleted===1)d=1;return[c.jid,parseInt(c.version,10),parseInt(c.created,10),parseInt(c.edited,10),d,c.contents,c.tags,c.type,parseInt(c.reminder,10),c.source]});this.updateBatchNotes(b,
a)},updateBatchNotes:function(a,b){this.parent.DB.transaction(function(c){for(var d=0;d<b.length;d++)c.executeSql(a,b[d],function(){},function(){debug("BAD _updateNotes")})})}};Atomate.database.person={parent:Atomate.database,schema:"jid INT PRIMARY KEY, version INT, created INT, edited INT, deleted INT, modified INT, name TEXT, nickname TEXT, email1 TEXT, email2 TEXT, email3 TEXT, photourl TEXT, source TEXT, fbid INT, url TEXT, priority TEXT, tag TEXT",properties:"(jid, version, created, edited, deleted, modified, name, nickname, email1, email2, email3, photourl, source, fbid, url, priority, tag)",values:"(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)",addPerson:function(a,b,c,d,
e,f,g,h,i,j,l,m,n,o,t,u,v){this.parent.DB.transaction(function(w){var p=0,q=parseInt(q,10),r=parseInt(r,10),s=parseInt(s,10);if(e===1||e===true||e==="true")p=1;w.executeSql("INSERT INTO person VALUES"+this_.values+";",[q,b,r,s,p,0,g,h,i,j,l,m,n,o,t,u,v],function(){debug("PERSON INSERT - person DB")})})},addNewPerson:function(a,b,c){var d=this;this.parent._getUniqueJID("person",function(e){d.parent.DB.transaction(function(f){f.executeSql("INSERT INTO person VALUES"+d.values+";",[e,0,a,a,0,1,name,nickname,
email1,email2,email3,photourl,source,fbid,url,priority,tag],function(){debug("PERSON INSERT - person DB")})});c(e)})},editPerson:function(a,b,c,d,e,f,g){debug("Updating person in database: "+a);debug(c);debug(d);this.parent.DB.transaction(function(h){h.executeSql("INSERT OR REPLACE INTO person "+this_.properties+" VALUES"+this_.values+";",[a,b,c,d,e,g,name,nickname,email1,email2,email3,photourl,source,fbid,url,priority,tag],function(){debug("SUCCESSFUL PERSON UPSERT to DB")})})},deletePerson:function(a){var b=
this;this.getPersonById(a,function(c){c!==null&&b.parent.DB.transaction(function(d){d.executeSql("INSERT OR REPLACE INTO person "+b.properties+" VALUES"+b.values+";",[a,c.version,c.created,c.edited,1,1,c.name,c.nickname,c.email1,c.email2,c.email3,c.photourl,c.source,c.fbid,c.url,c.priority,c.tag],function(){debug("DB: person-delete success")})})})},getPersonById:function(a,b){this.parent.DB.transaction(function(c){c.executeSql("SELECT * FROM person WHERE jid=? LIMIT 1",[a],function(d,e){if(e.rows.length===
1){var f=e.rows.item(0);b(f)}else b(null)},function(d,e){debug("Unsuccessful get");debug(e);b(null)})})},getAllPeople:function(a,b,c){this.parent.DB.transaction(function(d){d.executeSql("SELECT * FROM person WHERE deleted = ? ORDER BY created DESC",[a?1:0],function(e,f){debug("DB: Starting to grab person");for(var g=[],h=0;h<f.rows.length;h++){var i=f.rows.item(h);i.jid===-1&&!b||g.push({jid:i.jid,name:i.name,photourl:i.photourl,fbid:i.fbid,tag:i.tag,type:"person"})}debug("DB: Finished grabbing person.");
c(g)})})},putAllPeopleInDB:function(a){var b="INSERT OR REPLACE INTO person "+this.properties+" VALUES"+this.values+";";a=a.map(function(c){var d=0;if(c.deleted===true||c.deleted==="true"||c.deleted===1)d=1;return[parseInt(c.jid,10),parseInt(c.version,10),parseInt(c.created,10),parseInt(c.edited,10),d,parseInt(c.modified,10),c.name,c.nickname,c.email1,c.email2,c.email3,c.photourl,c.source,parseInt(c.fbid,10),c.url,c.priority,c.tag]});this.updateBatchPerson(b,a)},updateBatchPerson:function(a,b){this.parent.DB.transaction(function(c){for(var d=
0;d<b.length;d++)c.executeSql(a,b[d],function(){},function(e,f){debug(f);debug("BAD _updatePerson")})})}};Atomate.auth={parent:Atomate,initialize:function(){this.progressDiv=jQuery("#progress");this.me=this.getMe();this.data=[];this.displayServices()},getMe:function(){return{id:"self",name:"me"}},displayServices:function(){},interval_map_lite:function(a,b,c){var d=this;return this.parent.util.interval_map(a,b,c!==undefined?c:function(){},function(e){d.parent.log(e)},600,this.parent)},logProgress:function(a){if(!this.progressDiv)this.progressDiv=jQuery("#progress");console.log(a);this.progressDiv.append("<li><span>"+
a+'</span><img src="../img/remove.png" class="remove" />')},logError:function(a){if(!this.progressDiv)this.progressDiv=jQuery("#progress");console.log(a);this.progressDiv.append("<li><span>ERROR: "+a+'</span><img src="../img/remove.png" class="remove" />')}};window.fbAsyncInit=function(){var a=Atomate.auth;FB.init({appId:223573334338274,status:true,cookie:true,xfbml:true,scope:"user_events,read_mailbox,read_friendlists"});FB.getLoginStatus(function(b){b.session&&b.perms?a.Facebook.initialize(FB):FB.login(function(c){if(c.session)c.perms?a.Facebook.initialize(FB):a.logProgress("<li>you did not grant permission for the Feeder</li>");else console.log("not logged in ")},{perms:"user_events,read_mailbox,read_friendlists"})})};
Atomate.auth.Facebook={parent:Atomate.auth,initialize:function(a){var b=this.parent;b.logProgress("logged in and about to start saving Facebook data");a.api("/me/friends",function(c){if(c.data!==undefined){var d=[];b.logProgress("saving "+c.data.length+" people's Facebook profile");b.interval_map_lite(c.data,function(e){a.api("/"+e.id,function(f){f!==undefined&&b.Facebook.saveFriend(f,d)})},function(){console.log("about to save fb people");Atomate.database.person.putAllPeopleInDB(d)})}});a.api("/me/events",
function(c){if(c.data!==undefined){var d=[];b.logProgress("saving "+c.data.length+" Facebook events");b.interval_map_lite(c.data,function(e){b.Facebook.saveEvent(e,d)},function(){console.log("about to save fb events");Atomate.database.notes.putAllNotesInDB(d)})}})},saveFriend:function(a,b){var c=a.updated_time?(new Date(a.updated_time.substring(0,a.updated_time.length-5))).valueOf():(new Date).valueOf(),d=(a.first_name+a.last_name).toLowerCase().replace(/[\.,-\/#!$%\^&\*;:{}=\-_`~()]/g,"");d=d.split(" ").join("");
b.push({id:a.id,fbid:a.id,name:a.first_name+" "+a.last_name,nickname:"",modified:c,version:0,created:(new Date).valueOf(),url:a.website||"",priority:"",photourl:"http://graph.facebook.com/"+a.id+"/picture?type=square",source:"Facebook",tag:"@"+d,email1:"",email2:"",email3:""})},saveEvent:function(a,b){if(a&&a.start_time&&a.end_time){var c=(new Date(a.start_time.substring(0,a.end_time.length-5))).valueOf();a.end_time.substring(0,a.end_time.length-5);b.push({id:a.id,version:0,created:(new Date).valueOf(),
modified:0,contents:a.name+" http://www.facebook.com/event.php?eid="+a.id+" #facebook",tags:"#facebook",type:"event",source:"Facebook",reminder:c})}}};
